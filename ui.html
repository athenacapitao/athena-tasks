<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Athena Tasks</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-base: #0D0D0D;
      --bg-surface: #161616;
      --bg-elevated: #1E1E1E;
      --bg-hover: #252525;
      --text-primary: #E5E5E5;
      --text-secondary: #888;
      --text-muted: #555;
      --border: #2A2A2A;
      --border-focus: #404040;
      --accent: #3B82F6;
      --accent-hover: #2563EB;
      --status-backlog: #6B7280;
      --status-in-progress: #3B82F6;
      --status-blocked: #EF4444;
      --status-in-review: #F59E0B;
      --status-done: #10B981;
      --priority-critical: #DC2626;
      --priority-high: #F97316;
      --priority-medium: #EAB308;
      --priority-low: #6B7280;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
      background: var(--bg-base);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    header {
      height: 48px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
    }

    .logo {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    /* Project Tabs */
    .project-tabs {
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 4px;
      padding: 0 20px;
      overflow-x: auto;
      flex-shrink: 0;
    }

    .tab {
      padding: 10px 16px;
      border: none;
      background: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      transition: color 0.2s;
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--text-primary);
      border-bottom-color: var(--accent);
    }

    .tab-count {
      margin-left: 6px;
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Filter Row */
    .filter-row {
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .filter-dropdown {
      position: relative;
    }

    .filter-btn {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-btn:hover {
      background: var(--bg-hover);
    }

    .filter-btn.active {
      color: var(--text-primary);
      border-color: var(--accent);
    }

    .filter-menu {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px;
      min-width: 160px;
      z-index: 100;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    .filter-menu.show {
      display: block;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    .filter-option:hover {
      background: var(--bg-hover);
    }

    .filter-option input[type="checkbox"] {
      margin: 0;
    }

    .filter-pills {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .filter-pill {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill-remove {
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 700;
    }

    .pill-remove:hover {
      color: var(--text-primary);
    }

    .clear-filters {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px;
    }

    .clear-filters:hover {
      color: var(--text-primary);
    }

    /* Main Content */
    main {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .task-section {
      margin-bottom: 24px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      cursor: pointer;
      user-select: none;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-count {
      color: var(--text-muted);
      font-size: 12px;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .task-row {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 16px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
      overflow: hidden;
    }

    .task-row:hover {
      background: var(--bg-hover);
    }

    .task-row.blocked {
      background: rgba(239, 68, 68, 0.05);
    }

    .task-row.done-task {
      opacity: 0.6;
    }

    .priority-bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
    }

    .priority-bar.critical { background: var(--priority-critical); }
    .priority-bar.high { background: var(--priority-high); }
    .priority-bar.medium { background: var(--priority-medium); }
    .priority-bar.low { background: var(--priority-low); }

    .task-checkbox {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      margin-left: 3px;
    }

    .task-content {
      flex: 1;
      min-width: 0;
    }

    .task-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-meta {
      display: flex;
      gap: 10px;
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-status {
      flex-shrink: 0;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .task-status.backlog { background: rgba(107, 114, 128, 0.15); color: var(--status-backlog); }
    .task-status.in_progress { background: rgba(59, 130, 246, 0.15); color: var(--status-in-progress); }
    .task-status.blocked { background: rgba(239, 68, 68, 0.15); color: var(--status-blocked); }
    .task-status.in_review { background: rgba(245, 158, 11, 0.15); color: var(--status-in-review); }
    .task-status.done { background: rgba(16, 185, 129, 0.15); color: var(--status-done); }

    /* Footer */
    footer {
      height: 28px;
      background: var(--bg-surface);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      font-size: 11px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .footer-stats {
      display: flex;
      gap: 16px;
    }

    .sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sync-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--status-done);
    }

    .sync-indicator.syncing {
      background: var(--status-in-progress);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Detail Panel */
    .detail-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 420px;
      height: 100vh;
      background: var(--bg-elevated);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 200;
      display: flex;
      flex-direction: column;
    }

    .detail-panel.open {
      transform: translateX(0);
    }

    .dp-header {
      height: 56px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
    }

    .dp-back-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 20px;
      padding: 8px;
      border-radius: 4px;
    }

    .dp-back-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .dp-more-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      padding: 8px;
      border-radius: 4px;
    }

    .dp-more-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .dp-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .dp-section {
      margin-bottom: 24px;
    }

    .dp-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .dp-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .dp-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .dp-field {
      margin-bottom: 12px;
    }

    .dp-select, .dp-input, .dp-textarea {
      width: 100%;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
    }

    .dp-select:focus, .dp-input:focus, .dp-textarea:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .dp-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .subtasks-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .subtask-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-surface);
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .subtask-item input[type="checkbox"] {
      margin: 0;
    }

    .subtask-text {
      flex: 1;
      font-size: 13px;
      color: var(--text-primary);
    }

    .subtask-text.done {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .subtask-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 14px;
    }

    .subtask-delete:hover {
      color: var(--priority-critical);
    }

    .subtask-add-btn {
      background: none;
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      width: 100%;
      text-align: left;
    }

    .subtask-add-btn:hover {
      border-color: var(--border-focus);
      color: var(--text-primary);
    }

    .subtask-input-row {
      display: flex;
      gap: 8px;
    }

    .subtask-input {
      flex: 1;
    }

    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .activity-item {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .activity-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .comment-input {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .comment-input input {
      flex: 1;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 60px;
      right: 20px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 13px;
      color: var(--text-primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 400;
      animation: slideIn 0.3s ease;
    }

    .toast.error {
      border-color: var(--priority-critical);
      background: rgba(220, 38, 38, 0.1);
    }

    .toast.success {
      border-color: var(--status-done);
      background: rgba(16, 185, 129, 0.1);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Complete Animation */
    .complete-celebration {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 80px;
      z-index: 500;
      animation: celebrate 1s ease forwards;
      pointer-events: none;
    }

    @keyframes celebrate {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0;
      }
    }

    /* Mobile Responsive */
    @media (max-width: 640px) {
      .detail-panel {
        width: 100%;
      }

      header {
        padding: 0 12px;
      }

      .project-tabs {
        padding: 0 12px;
      }

      .filter-row {
        padding: 10px 12px;
      }

      main {
        padding: 12px;
      }

      footer {
        padding: 0 12px;
      }

      .footer-stats {
        gap: 8px;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 14px;
    }

    /* Mobile breakpoint */
    @media (max-width: 640px) {
      .detail-panel { width: 100%; }
      .filter-row { padding: 8px 12px; }
      main { padding: 12px; }
      header { padding: 0 12px; }
      footer { padding: 0 12px; }
      .task-title { white-space: normal; }
      .task-meta { flex-wrap: wrap; }
      /* P10-14: Stats view responsive ‚Äî stack 2-col grids to 1 */
      main [style*="grid-template-columns: 1fr 1fr"],
      main [style*="grid-template-columns:1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
    }

    /* Subtask progress bar on rows */
    .subtask-progress {
      width: 40px;
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-right: 4px;
    }

    .subtask-progress-fill {
      height: 100%;
      background: var(--status-done);
      border-radius: 2px;
    }

    /* P7-01: Enhanced Toast System */
    .toast-container {
      position: fixed;
      top: 60px;
      right: 16px;
      z-index: 200;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast-notification {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 13px;
      color: var(--text-primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      animation: slideInRight 0.3s ease;
      cursor: pointer;
      pointer-events: auto;
      min-width: 250px;
      max-width: 400px;
    }

    .toast-notification.success {
      border-left: 3px solid var(--status-done);
    }

    .toast-notification.error {
      border-left: 3px solid var(--priority-critical);
    }

    .toast-notification.info {
      border-left: 3px solid var(--accent);
    }

    .toast-notification.warning {
      border-left: 3px solid var(--priority-medium);
    }

    .toast-notification.fade-out {
      animation: fadeOut 0.3s ease forwards;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(20px);
      }
    }

    /* P7-03: Keyboard Navigation */
    .task-row.selected {
      background: var(--bg-hover);
      outline: 2px solid var(--accent);
      outline-offset: -2px;
    }

    /* P7-04: Search Bar */
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-input-wrapper {
      position: relative;
      overflow: hidden;
      width: 0;
      opacity: 0;
      transition: width 0.3s ease, opacity 0.3s ease;
    }

    .search-input-wrapper.open {
      width: 240px;
      opacity: 1;
    }

    .search-input {
      width: 100%;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 8px 32px 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .search-clear {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
    }

    .search-clear:hover {
      color: var(--text-primary);
    }

    .search-results-count {
      font-size: 12px;
      color: var(--text-secondary);
      margin-left: 20px;
    }

    mark {
      background: rgba(59, 130, 246, 0.3);
      color: var(--text-primary);
      padding: 0 2px;
      border-radius: 2px;
    }

    /* P7-06: Loading Skeletons */
    .skeleton-row {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 16px;
      position: relative;
      overflow: hidden;
    }

    .skeleton-block {
      background: var(--bg-elevated);
      border-radius: 4px;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
    }

    .skeleton-priority {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--border);
    }

    .skeleton-checkbox {
      width: 18px;
      height: 18px;
      margin-left: 3px;
      border-radius: 3px;
    }

    .skeleton-title {
      flex: 1;
      height: 16px;
      max-width: 300px;
    }

    .skeleton-meta {
      width: 100px;
      height: 12px;
    }

    .skeleton-status {
      width: 70px;
      height: 24px;
      border-radius: 4px;
    }

    .skeleton-tab {
      padding: 10px 16px;
      height: 20px;
      width: 80px;
      background: var(--bg-elevated);
      border-radius: 4px;
      animation: skeleton-pulse 1.5s ease-in-out infinite;
    }

    @keyframes skeleton-pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    /* P7-07: Status Dropdown */
    .status-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      min-width: 140px;
      z-index: 150;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    .status-option {
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      transition: background 0.2s;
    }

    .status-option:hover {
      background: var(--bg-hover);
    }

    .status-option.backlog { color: var(--status-backlog); }
    .status-option.in_progress { color: var(--status-in-progress); }
    .status-option.blocked { color: var(--status-blocked); }
    .status-option.in_review { color: var(--status-in-review); }
    .status-option.done { color: var(--status-done); }

    /* P7-08: Links Section */
    .links-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .link-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-surface);
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      position: relative;
    }

    .link-item:hover .link-delete,
    .link-item:hover .link-copy {
      opacity: 1;
    }

    .link-copy {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .link-icon {
      font-size: 16px;
      flex-shrink: 0;
    }

    .link-content {
      flex: 1;
      min-width: 0;
    }

    .link-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .link-url {
      font-size: 13px;
      color: var(--accent);
      text-decoration: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }

    .link-url:hover {
      text-decoration: underline;
    }

    .link-delete {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .link-delete:hover {
      color: var(--priority-critical);
    }

    .link-add-btn {
      background: none;
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      width: 100%;
      text-align: left;
    }

    .link-add-btn:hover {
      border-color: var(--border-focus);
      color: var(--text-primary);
    }

    .link-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: var(--bg-surface);
      padding: 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .link-form-row {
      display: flex;
      gap: 8px;
    }

    /* P7-09: Mobile Responsive */
    @media (max-width: 640px) {
      .detail-panel {
        width: 100%;
        animation: slideUp 0.3s ease;
      }

      .detail-panel.open {
        transform: translateX(0);
      }

      body.panel-open {
        overflow: hidden;
      }

      .task-row {
        height: 64px;
        flex-direction: column;
        align-items: flex-start;
        padding: 12px 16px;
      }

      .task-row .task-content {
        width: 100%;
      }

      .task-status {
        margin-top: 4px;
        margin-left: 24px;
      }

      .project-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tab {
        min-width: 44px;
        padding: 12px 16px;
      }

      #mobileFilterToggle {
        display: flex !important;
      }

      #filterDropdowns {
        display: none !important;
      }

      .filter-sheet-overlay.show {
        display: block;
      }

      .logo .logo-text {
        display: none;
      }

      .modal {
        width: 100%;
        max-width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
      }

      .search-input-wrapper.open {
        width: 180px;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    /* P7-09: Filter Sheet Overlay */
    .filter-sheet-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 240;
      display: none;
    }

    .filter-sheet-overlay.show {
      display: block;
    }

    .filter-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-elevated);
      border-top: 1px solid var(--border);
      border-radius: 16px 16px 0 0;
      max-height: 60vh;
      overflow-y: auto;
      z-index: 250;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      padding: 20px;
    }

    .filter-sheet.open {
      transform: translateY(0);
    }

    .filter-sheet-section {
      margin-bottom: 16px;
    }

    .filter-sheet-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .filter-sheet-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-sheet-chip {
      padding: 8px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--bg-surface);
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
    }

    .filter-sheet-chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* P7-10: Dashboard View */
    .dashboard-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .dashboard-summary {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .dashboard-summary {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .dashboard-stat {
      text-align: center;
    }

    .dashboard-stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .dashboard-stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .project-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .project-card:hover {
      background: var(--bg-hover);
    }

    .project-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .project-color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .project-card-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .project-progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .project-progress-fill {
      height: 100%;
      background: var(--status-done);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .project-stats-row {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .project-breakdown {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .project-breakdown-pill {
      background: var(--bg-elevated);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    /* P10-12: Project status dropdown */
    .project-status-badge {
      margin-left: auto;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      position: relative;
    }

    .project-status-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px;
      min-width: 120px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    .project-status-option {
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-primary);
    }

    .project-status-option:hover {
      background: var(--bg-hover);
    }

    /* P10-12: Confetti animation */
    @keyframes confetti-fall {
      0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      top: -10px;
      width: 8px;
      height: 8px;
      border-radius: 2px;
      animation: confetti-fall 3s ease-out forwards;
    }

    /* P7-11: Context Menu */
    .context-menu {
      position: fixed;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      min-width: 180px;
      z-index: 300;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      display: none;
    }

    .context-menu.show {
      display: block;
    }

    .context-menu-item {
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .context-menu-item:hover {
      background: var(--bg-hover);
    }

    .context-menu-submenu {
      position: absolute;
      left: 100%;
      top: 0;
      margin-left: 4px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      min-width: 140px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      display: none;
    }

    .context-menu-item:hover .context-menu-submenu {
      display: block;
    }

    /* History view styles */
    .history-filters {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--bg-elevated);
      border-radius: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .history-filters input,
    .history-filters select {
      padding: 8px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
      flex: 1;
      min-width: 150px;
    }

    .history-task {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0.8;
    }

    .history-task:hover {
      opacity: 1;
      border-color: var(--status-done);
      transform: translateX(4px);
    }

    .history-task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .history-task-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .history-task-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    .history-task-meta .priority-badge {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
      letter-spacing: 0.5px;
    }
    .priority-badge.priority-critical { color: var(--priority-critical); background: rgba(220,38,38,0.15); }
    .priority-badge.priority-high { color: var(--priority-high); background: rgba(249,115,22,0.15); }
    .priority-badge.priority-medium { color: var(--priority-medium); background: rgba(234,179,8,0.15); }
    .priority-badge.priority-low { color: var(--priority-low); background: rgba(107,114,128,0.15); }

    .history-report-preview {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 4px;
    }

    .history-pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      margin-top: 16px;
      background: var(--bg-elevated);
      border-radius: 8px;
    }

    .history-pagination-info {
      font-size: 13px;
      color: var(--text-muted);
    }

    .history-pagination-controls {
      display: flex;
      gap: 8px;
    }

    .history-pagination button {
      padding: 6px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .history-pagination button:hover:not(:disabled) {
      background: var(--accent);
      border-color: var(--accent);
    }

    .history-pagination button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="logo"><span class="logo-text">Athena Tasks</span></div>
      <div class="header-actions">
        <div class="search-container">
          <div class="search-input-wrapper" id="searchWrapper">
            <input type="text" class="search-input" id="searchInput" placeholder="Search tasks...">
            <button class="search-clear" id="searchClear">√ó</button>
          </div>
          <button class="icon-btn" id="searchBtn" title="Search (/)">üîç</button>
        </div>
        <button class="icon-btn" id="statsBtn" title="Stats (üìä)">üìä</button>
        <button class="icon-btn" id="disconnectBtn" title="Disconnect">‚èª</button>
        <button class="btn" id="newTaskBtn">+ New</button>
      </div>
    </header>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="project-tabs" id="projectTabs"></div>

    <div class="filter-row" id="filterRow">
      <button class="filter-btn mobile-filter-toggle" id="mobileFilterToggle" style="display:none">
        Filters <span id="mobileFilterCount"></span> <span>‚ñº</span>
      </button>
      <div class="filter-dropdowns" id="filterDropdowns">
      <div class="filter-dropdown">
        <button class="filter-btn" data-filter="status">
          Status
          <span>‚ñº</span>
        </button>
        <div class="filter-menu" data-menu="status">
          <label class="filter-option">
            <input type="checkbox" value="backlog"> Backlog
          </label>
          <label class="filter-option">
            <input type="checkbox" value="in_progress"> In Progress
          </label>
          <label class="filter-option">
            <input type="checkbox" value="blocked"> Blocked
          </label>
          <label class="filter-option">
            <input type="checkbox" value="in_review"> In Review
          </label>
          <label class="filter-option">
            <input type="checkbox" value="done"> Done
          </label>
        </div>
      </div>

      <div class="filter-dropdown">
        <button class="filter-btn" data-filter="priority">
          Priority
          <span>‚ñº</span>
        </button>
        <div class="filter-menu" data-menu="priority">
          <label class="filter-option">
            <input type="checkbox" value="critical"> Critical
          </label>
          <label class="filter-option">
            <input type="checkbox" value="high"> High
          </label>
          <label class="filter-option">
            <input type="checkbox" value="medium"> Medium
          </label>
          <label class="filter-option">
            <input type="checkbox" value="low"> Low
          </label>
        </div>
      </div>

      <div class="filter-dropdown">
        <button class="filter-btn" data-filter="assigned_to">
          Assigned
          <span>‚ñº</span>
        </button>
        <div class="filter-menu" data-menu="assigned_to">
          <label class="filter-option">
            <input type="checkbox" value="wilson"> Wilson
          </label>
          <label class="filter-option">
            <input type="checkbox" value="athena"> Athena
          </label>
          <label class="filter-option">
            <input type="checkbox" value="shared"> Shared
          </label>
        </div>
      </div>

      <div class="filter-dropdown">
        <button class="filter-btn" data-filter="tags">
          Tags
          <span>‚ñº</span>
        </button>
        <div class="filter-menu" data-menu="tags" id="tagsFilterMenu"></div>
      </div>

      </div><!-- /filter-dropdowns -->
      <div class="filter-pills" id="filterPills"></div>
      <button class="clear-filters" id="clearFilters" style="display: none;">Clear All</button>
    </div>

    <!-- Mobile Filter Bottom Sheet -->
    <div class="filter-sheet-overlay" id="filterSheetOverlay"></div>
    <div class="filter-sheet" id="filterSheet">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <span style="font-weight:600;font-size:16px;color:var(--text-primary)">Filters</span>
        <button class="icon-btn" id="closeFilterSheet" style="font-size:20px">√ó</button>
      </div>
      <div id="filterSheetContent"></div>
      <div style="margin-top:16px;display:flex;gap:8px">
        <button class="btn btn-secondary" id="filterSheetClear" style="flex:1">Clear All</button>
        <button class="btn" id="filterSheetApply" style="flex:1">Apply</button>
      </div>
    </div>

    <main id="mainContent"></main>

    <footer>
      <div class="footer-stats" id="footerStats"></div>
      <div class="sync-status">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncText">Synced</span>
      </div>
    </footer>
  </div>

  <!-- Detail Panel -->
  <div class="detail-panel" id="detailPanel">
    <div class="dp-header">
      <button class="dp-back-btn" id="closeDetail">‚Üê</button>
      <button class="dp-more-btn">‚ãÆ</button>
    </div>
    <div class="dp-content" id="detailContent"></div>
  </div>

  <!-- Auth Modal -->
  <div class="modal-overlay" id="authModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Authentication Required</div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Access Token</label>
          <input type="password" class="form-input" id="authTokenInput" placeholder="Enter your token">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="authSubmit">Continue</button>
      </div>
    </div>
  </div>

  <!-- New Task Modal -->
  <div class="modal-overlay" id="newTaskModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">New Task</div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Title *</label>
          <input type="text" class="form-input" id="newTaskTitle" placeholder="Task title">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="newTaskDescription" placeholder="Task description"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Project *</label>
          <select class="form-select" id="newTaskProject"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="form-select" id="newTaskPriority">
            <option value="medium">Medium</option>
            <option value="low">Low</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Assigned To</label>
          <select class="form-select" id="newTaskAssigned">
            <option value="athena">Athena</option>
            <option value="wilson">Wilson</option>
            <option value="shared">Shared</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Deadline</label>
          <input type="date" class="form-input" id="newTaskDeadline">
        </div>
        <div class="form-group">
          <label class="form-label">Tags</label>
          <input type="text" class="form-input" id="newTaskTags" placeholder="Comma-separated tags">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelNewTask">Cancel</button>
        <button class="btn" id="createTaskBtn">Create Task</button>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu"></div>

  <script>
    // State
    let state = {
      tasks: [],
      projects: [],
      selectedProject: 'ALL',
      selectedTask: null,
      filters: {
        status: [],
        priority: [],
        assigned_to: [],
        tags: []
      },
      syncing: false,
      pollInterval: null,
      lastSync: null,
      doneExpanded: false,
      searchQuery: '',
      dashboardView: false,
      selectedTaskIndex: -1,
      isLoading: true,
      historyView: false,
      historyData: { tasks: [], pagination: { page: 1, per_page: 20, total: 0, total_pages: 0 } },
      historyFilters: { project_id: '', month: '', search: '' },
      historyPage: 1,
      statsView: false,
      statsData: null,
      statsPeriod: 'month',
      lastResponseTime: null,
      showArchived: false
    };

    // Utility: API client (with toast integration)
    async function api(endpoint, options = {}) {
      const token = localStorage.getItem('athena_tasks_token');
      const headers = {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` })
      };

      const response = await fetch(`/api${endpoint}`, {
        ...options,
        headers: { ...headers, ...options.headers }
      });

      if (response.status === 401) {
        localStorage.removeItem('athena_tasks_token');
        showAuthModal();
        throw new Error('Unauthorized');
      }

      // P10-17: Capture response time from header
      const responseTime = response.headers.get('X-Response-Time');
      if (responseTime) state.lastResponseTime = responseTime;

      if (!response.ok) {
        const error = await response.json().catch(() => ({ error: 'Request failed' }));
        const errorMsg = error.error || 'Request failed';
        // Show error toast for mutations (not for GET requests)
        if (options.method && options.method !== 'GET') {
          showToast(errorMsg, 'error');
        }
        throw new Error(errorMsg);
      }

      return response.json();
    }

    // Utility: Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Utility: Validate URL is safe (no javascript: or data: URIs)
    function isSafeUrl(url) {
      try {
        const parsed = new URL(url);
        return ['http:', 'https:', 'mailto:'].includes(parsed.protocol);
      } catch {
        return false;
      }
    }

    // Utility: Format date
    function formatDate(dateStr) {
      if (!dateStr) return 'No deadline';
      const date = new Date(dateStr);
      const now = new Date();
      const diffTime = date - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays < 0) return `${Math.abs(diffDays)}d overdue`;
      if (diffDays === 0) return 'Due today';
      if (diffDays === 1) return 'Due tomorrow';
      return `${diffDays}d left`;
    }

    // Utility: Format relative time
    function formatRelativeTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;

      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `${diffHours}h ago`;

      const diffDays = Math.floor(diffHours / 24);
      if (diffDays < 7) return `${diffDays}d ago`;

      return date.toLocaleDateString();
    }

    // P7-01: Enhanced Toast Notification System
    const toastQueue = [];
    const MAX_TOASTS = 3;
    const TOAST_DURATION = { success: 3000, error: 5000, info: 3000, warning: 4000 };

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast-notification ${type}`;
      toast.textContent = message;

      // Add to queue
      toastQueue.push(toast);

      // If over max, remove oldest
      if (toastQueue.length > MAX_TOASTS) {
        const oldest = toastQueue.shift();
        oldest.classList.add('fade-out');
        setTimeout(() => oldest.remove(), 300);
      }

      container.appendChild(toast);

      // Click to dismiss
      toast.addEventListener('click', () => {
        toast.classList.add('fade-out');
        const index = toastQueue.indexOf(toast);
        if (index > -1) toastQueue.splice(index, 1);
        setTimeout(() => toast.remove(), 300);
      });

      // Auto dismiss
      const duration = TOAST_DURATION[type] || 3000;
      setTimeout(() => {
        if (toast.parentElement) {
          toast.classList.add('fade-out');
          const index = toastQueue.indexOf(toast);
          if (index > -1) toastQueue.splice(index, 1);
          setTimeout(() => toast.remove(), 300);
        }
      }, duration);
    }

    // P8-06: Fetch history data
    async function fetchHistory() {
      const params = new URLSearchParams();
      params.set('page', state.historyPage);
      params.set('per_page', '20');
      if (state.historyFilters.project_id) params.set('project_id', state.historyFilters.project_id);
      if (state.historyFilters.month) params.set('month', state.historyFilters.month);
      if (state.historyFilters.search) params.set('search', state.historyFilters.search);

      try {
        const data = await api(`/history?${params.toString()}`);
        state.historyData = data;
      } catch (err) {
        showToast('Failed to load history', 'error');
      }
      render();
    }

    // P7-02: Optimistic Update with Rollback
    async function optimisticUpdate(taskId, changes, apiCall) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      // Snapshot
      const snapshot = JSON.parse(JSON.stringify(task));

      // Apply changes immediately
      Object.assign(task, changes);
      render();

      try {
        await apiCall();
        showToast('Updated successfully', 'success');
        fetchData(); // Get authoritative state
      } catch (error) {
        // Rollback
        const taskIndex = state.tasks.findIndex(t => t.id === taskId);
        if (taskIndex > -1) {
          state.tasks[taskIndex] = snapshot;
        }
        render();
        showToast(error.message, 'error');
      }
    }

    // Utility: Show celebration
    function showCelebration() {
      const celebration = document.createElement('div');
      celebration.className = 'complete-celebration';
      celebration.textContent = '‚úì';
      document.body.appendChild(celebration);

      setTimeout(() => {
        celebration.remove();
      }, 1000);
    }

    // P10-12: Project completion confetti
    function showProjectConfetti() {
      const container = document.createElement('div');
      container.className = 'confetti-container';
      const colors = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];
      for (let i = 0; i < 40; i++) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.left = Math.random() * 100 + '%';
        piece.style.background = colors[Math.floor(Math.random() * colors.length)];
        piece.style.animationDelay = Math.random() * 1 + 's';
        piece.style.animationDuration = (2 + Math.random() * 2) + 's';
        container.appendChild(piece);
      }
      document.body.appendChild(container);
      setTimeout(() => container.remove(), 4000);
    }

    // Auth
    function showAuthModal() {
      document.getElementById('authModal').classList.add('show');
    }

    function hideAuthModal() {
      document.getElementById('authModal').classList.remove('show');
    }

    document.getElementById('authSubmit').addEventListener('click', () => {
      const token = document.getElementById('authTokenInput').value.trim();
      if (token) {
        localStorage.setItem('athena_tasks_token', token);
        hideAuthModal();
        init();
      }
    });

    document.getElementById('authTokenInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('authSubmit').click();
      }
    });

    // Fetch data with change detection (P3-15, P7-06: loading state)
    async function fetchData() {
      const wasLoading = state.isLoading;
      state.syncing = true;
      updateSyncStatus();

      // P7-06: Show skeletons on initial load
      if (state.isLoading && state.tasks.length === 0) {
        renderLoadingSkeletons();
        renderProjectTabs();
      }

      try {
        const [tasks, projects] = await Promise.all([
          api('/tasks?include_done=true'),
          api('/projects')
        ]);

        // Change detection ‚Äî skip re-render if data unchanged
        const tasksChanged = JSON.stringify(tasks) !== JSON.stringify(state.tasks);
        const projectsChanged = JSON.stringify(projects) !== JSON.stringify(state.projects);

        state.tasks = tasks;
        state.projects = projects;
        state.syncing = false;
        state.isLoading = false;
        state.lastSync = Date.now();
        updateSyncStatus();

        if (tasksChanged || projectsChanged || wasLoading) {
          render();
        }
      } catch (error) {
        state.syncing = false;
        state.isLoading = false;
        updateSyncStatus();
        if (error.message !== 'Unauthorized') {
          // P7-06: Show error state on initial load failure
          if (wasLoading && state.tasks.length === 0) {
            const container = document.getElementById('mainContent');
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">‚ö†Ô∏è</div>
                <div class="empty-state-text">Failed to load tasks: ${escapeHtml(error.message)}</div>
                <div style="margin-top:16px">
                  <button class="btn" onclick="fetchData()">Retry</button>
                </div>
              </div>
            `;
          } else {
            showToast(error.message, 'error');
          }
        }
      }
    }

    // Update sync status with seconds elapsed
    function updateSyncStatus() {
      const indicator = document.getElementById('syncIndicator');
      const text = document.getElementById('syncText');

      if (state.syncing) {
        indicator.classList.add('syncing');
        text.textContent = 'Syncing...';
      } else {
        indicator.classList.remove('syncing');
        if (state.lastSync) {
          const ago = Math.round((Date.now() - state.lastSync) / 1000);
          const rt = state.lastResponseTime ? ` (${state.lastResponseTime})` : '';
          text.textContent = `Synced ${ago}s ago${rt}`;
        } else {
          text.textContent = 'Synced';
        }
      }
    }

    // Update sync timer every second
    setInterval(() => {
      if (!state.syncing && state.lastSync) {
        updateSyncStatus();
      }
    }, 1000);

    // Get filtered tasks (P7-04: includes search)
    function getFilteredTasks() {
      let filtered = state.tasks;

      // Filter by project
      if (state.selectedProject !== 'ALL') {
        filtered = filtered.filter(t => t.project_id === state.selectedProject);
      }

      // Filter by status
      if (state.filters.status.length > 0) {
        filtered = filtered.filter(t => state.filters.status.includes(t.status));
      }

      // Filter by priority
      if (state.filters.priority.length > 0) {
        filtered = filtered.filter(t => state.filters.priority.includes(t.priority));
      }

      // Filter by assigned_to
      if (state.filters.assigned_to.length > 0) {
        filtered = filtered.filter(t => state.filters.assigned_to.includes(t.assigned_to));
      }

      // Filter by tags
      if (state.filters.tags.length > 0) {
        filtered = filtered.filter(t =>
          state.filters.tags.some(tag => t.tags && t.tags.includes(tag))
        );
      }

      // P7-04: Search filter
      if (state.searchQuery.trim()) {
        const query = state.searchQuery.toLowerCase();
        filtered = filtered.filter(t => {
          const title = (t.title || '').toLowerCase();
          const desc = (t.description || '').toLowerCase();
          return title.includes(query) || desc.includes(query);
        });
      }

      return filtered;
    }

    // P7-04: Highlight search matches
    function highlightMatches(text, query) {
      if (!query.trim()) return escapeHtml(text);
      const escaped = escapeHtml(text);
      const regex = new RegExp(`(${escapeHtml(query).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return escaped.replace(regex, '<mark>$1</mark>');
    }

    // P7-10: Render Dashboard View
    function renderDashboard() {
      const container = document.getElementById('mainContent');

      // Calculate global stats
      const totalTasks = state.tasks.length;
      const totalDone = state.tasks.filter(t => t.status === 'done').length;
      const totalOverdue = state.tasks.filter(t =>
        t.status !== 'done' && t.deadline && new Date(t.deadline) < new Date()
      ).length;

      // Completed this week
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const completedThisWeek = state.tasks.filter(t =>
        t.status === 'done' && t.completed_at && new Date(t.completed_at) > weekAgo
      ).length;

      const athenaQueue = state.tasks.filter(t => t.assigned_to === 'athena' && t.status !== 'done').length;

      let html = `
        <div class="dashboard-summary">
          <div class="dashboard-stat">
            <div class="dashboard-stat-value">${totalTasks}</div>
            <div class="dashboard-stat-label">Total Tasks</div>
          </div>
          <div class="dashboard-stat">
            <div class="dashboard-stat-value" style="color:${totalOverdue > 0 ? 'var(--priority-critical)' : 'var(--text-primary)'}">${totalOverdue}</div>
            <div class="dashboard-stat-label">Overdue</div>
          </div>
          <div class="dashboard-stat">
            <div class="dashboard-stat-value" style="color:var(--status-done)">${completedThisWeek}</div>
            <div class="dashboard-stat-label">Done This Week</div>
          </div>
          <div class="dashboard-stat">
            <div class="dashboard-stat-value">${athenaQueue}</div>
            <div class="dashboard-stat-label">Athena's Queue</div>
          </div>
        </div>

        <div class="dashboard-grid">
          ${state.projects.filter(p => (p.status || 'active') !== 'archived' || state.showArchived).map(proj => {
            const stats = proj._stats || {};
            const total = (stats.pending || 0) + (stats.done || 0);
            const done = stats.done || 0;
            const completion = total > 0 ? Math.round((done / total) * 100) : 0;
            const overdue = stats.overdue || 0;
            const critical = stats.critical || 0;

            const statusColors = { active: 'var(--status-in-progress)', paused: 'var(--status-in-review)', completed: 'var(--status-done)', archived: 'var(--text-muted)' };
            const projStatus = proj.status || 'active';
            const isPaused = projStatus === 'paused';
            const isCompleted = projStatus === 'completed';

            return `
              <div class="project-card" data-project="${proj.id}" style="${isPaused ? 'opacity:0.6' : ''}${isCompleted ? ';border-color:var(--status-done)' : ''}">
                <div class="project-card-header">
                  <div class="project-color-dot" style="background:${proj.color || 'var(--accent)'}"></div>
                  <div class="project-card-name">${escapeHtml(proj.name)}</div>
                  <span class="project-status-badge" data-project-id="${proj.id}" data-project-status="${projStatus}" style="background:${statusColors[projStatus] || statusColors.active};color:#000">${projStatus}</span>
                </div>
                <div class="project-progress-bar">
                  <div class="project-progress-fill" style="width:${completion}%"></div>
                </div>
                <div class="project-stats-row">
                  <span>${done}/${total} tasks</span>
                  ${overdue > 0 ? `<span style="color:var(--priority-critical)">${overdue} overdue</span>` : ''}
                  ${critical > 0 ? `<span style="color:var(--priority-critical)">${critical} critical</span>` : ''}
                </div>
                <div class="project-breakdown">
                  ${stats.backlog ? `<span class="project-breakdown-pill" style="color:var(--status-backlog)">${stats.backlog} backlog</span>` : ''}
                  ${stats.in_progress ? `<span class="project-breakdown-pill" style="color:var(--status-in-progress)">${stats.in_progress} in progress</span>` : ''}
                  ${stats.blocked ? `<span class="project-breakdown-pill" style="color:var(--status-blocked)">${stats.blocked} blocked</span>` : ''}
                  ${stats.in_review ? `<span class="project-breakdown-pill" style="color:var(--status-in-review)">${stats.in_review} in review</span>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
        ${state.projects.some(p => (p.status || 'active') === 'archived') ? `
          <div style="text-align:center;margin-top:12px">
            <button class="btn btn-secondary" id="toggleArchivedBtn" style="font-size:12px;padding:4px 12px">
              ${state.showArchived ? 'Hide Archived' : 'Show Archived'}
            </button>
          </div>
        ` : ''}
      `;

      container.innerHTML = html;
    }

    // Render project tabs (P7-06: with skeletons)
    function renderProjectTabs() {
      const container = document.getElementById('projectTabs');

      // P7-06: Show skeleton tabs while loading
      if (state.isLoading && state.projects.length === 0) {
        container.innerHTML = Array(4).fill(0).map(() => '<div class="skeleton-tab"></div>').join('');
        return;
      }

      // Calculate total pending for ALL tab
      const totalPending = state.projects.reduce((sum, p) => sum + (p._stats?.pending || 0), 0);

      let html = `<button class="tab ${state.selectedProject === 'ALL' ? 'active' : ''}" data-project="ALL">
        ALL <span class="tab-count">${totalPending}</span>
      </button>`;

      state.projects.forEach(proj => {
        const active = state.selectedProject === proj.id ? 'active' : '';
        const count = proj._stats?.pending || 0;
        html += `<button class="tab ${active}" data-project="${proj.id}" style="${active ? `border-bottom-color: ${proj.color || 'var(--accent)'}` : ''}">
          ${escapeHtml(proj.name)} <span class="tab-count">${count}</span>
        </button>`;
      });

      // P7-10: Dashboard toggle (only on ALL tab)
      if (state.selectedProject === 'ALL') {
        html += `
          <label class="dashboard-toggle">
            <input type="checkbox" id="dashboardToggle" ${state.dashboardView ? 'checked' : ''}>
            <span>Dashboard</span>
          </label>
        `;
      }

      // P8-06: History tab
      html += `
        <button class="tab ${state.historyView ? 'active' : ''}" data-project="HISTORY" style="${state.historyView ? 'border-bottom-color: var(--status-done)' : ''}">
          History
        </button>
      `;

      container.innerHTML = html;
    }

    // Render filters
    function renderFilters() {
      // Update filter button states
      document.querySelectorAll('.filter-btn').forEach(btn => {
        const filterType = btn.dataset.filter;
        const hasActive = state.filters[filterType] && state.filters[filterType].length > 0;
        btn.classList.toggle('active', hasActive);
      });

      // Render tags filter menu dynamically
      const allTags = new Set();
      state.tasks.forEach(t => {
        if (t.tags && Array.isArray(t.tags)) {
          t.tags.forEach(tag => allTags.add(tag));
        }
      });

      const tagsMenu = document.getElementById('tagsFilterMenu');
      tagsMenu.innerHTML = Array.from(allTags).sort().map(tag => `
        <label class="filter-option">
          <input type="checkbox" value="${escapeHtml(tag)}" ${state.filters.tags.includes(tag) ? 'checked' : ''}> ${escapeHtml(tag)}
        </label>
      `).join('');

      // Render filter pills
      const pills = [];
      Object.entries(state.filters).forEach(([type, values]) => {
        values.forEach(value => {
          pills.push({ type, value });
        });
      });

      const pillsContainer = document.getElementById('filterPills');
      pillsContainer.innerHTML = pills.map(({ type, value }) => `
        <div class="filter-pill">
          <span>${escapeHtml(value)}</span>
          <span class="pill-remove" data-type="${type}" data-value="${escapeHtml(value)}">√ó</span>
        </div>
      `).join('');

      // Show/hide clear button
      document.getElementById('clearFilters').style.display = pills.length > 0 ? 'block' : 'none';

      // P7-09: Update mobile filter count
      if (typeof updateMobileFilterCount === 'function') updateMobileFilterCount();
    }

    // P7-06: Render loading skeletons
    function renderLoadingSkeletons() {
      const container = document.getElementById('mainContent');
      const skeletonRows = Array(5).fill(0).map(() => `
        <div class="skeleton-row">
          <div class="skeleton-priority"></div>
          <div class="skeleton-block skeleton-checkbox"></div>
          <div class="skeleton-block skeleton-title"></div>
          <div class="skeleton-block skeleton-meta"></div>
          <div class="skeleton-block skeleton-status"></div>
        </div>
      `).join('');

      container.innerHTML = `
        <div class="task-section">
          <div class="task-list" style="display:flex;flex-direction:column;gap:2px">
            ${skeletonRows}
          </div>
        </div>
      `;
    }

    // P7-05: Get contextual empty state message
    function getEmptyStateMessage() {
      const hasFilters = Object.values(state.filters).some(f => f.length > 0);
      const hasSearch = state.searchQuery.trim();

      if (state.tasks.length === 0) {
        return {
          icon: 'üìã',
          text: 'No tasks yet',
          action: '<button class="btn" onclick="document.getElementById(\'newTaskBtn\').click()">Create your first task</button>'
        };
      }

      if (hasSearch) {
        return {
          icon: 'üîç',
          text: `No results for "${escapeHtml(state.searchQuery)}"`,
          action: '<button class="btn btn-secondary" onclick="clearSearch()">Clear search</button>'
        };
      }

      if (hasFilters) {
        return {
          icon: 'üîç',
          text: 'No tasks match your filters',
          action: '<button class="btn btn-secondary" onclick="document.getElementById(\'clearFilters\').click()">Clear filters</button>'
        };
      }

      if (state.selectedProject !== 'ALL') {
        const project = state.projects.find(p => p.id === state.selectedProject);
        return {
          icon: 'üìã',
          text: project ? `No tasks in ${escapeHtml(project.name)}` : 'No tasks in this project',
          action: '<button class="btn" onclick="document.getElementById(\'newTaskBtn\').click()">Create a task</button>'
        };
      }

      const allDone = state.tasks.every(t => t.status === 'done');
      if (allDone) {
        return {
          icon: '‚úÖ',
          text: 'All caught up ‚Äî backlog is empty!',
          action: ''
        };
      }

      return {
        icon: 'üìã',
        text: 'No tasks found',
        action: ''
      };
    }

    // Render task list (P7-05, P7-06, P7-10)
    function renderTaskList() {
      const container = document.getElementById('mainContent');

      // P10-14: Stats view
      if (state.statsView) {
        renderStatsView();
        return;
      }

      // P8-06: History view
      if (state.historyView) {
        renderHistoryView();
        return;
      }

      // P7-10: Dashboard view
      if (state.dashboardView && state.selectedProject === 'ALL') {
        renderDashboard();
        return;
      }

      const filtered = getFilteredTasks();

      // P7-05: Contextual empty states
      if (filtered.length === 0) {
        const emptyState = getEmptyStateMessage();
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">${emptyState.icon}</div>
            <div class="empty-state-text">${emptyState.text}</div>
            ${emptyState.action ? `<div style="margin-top:16px">${emptyState.action}</div>` : ''}
          </div>
        `;
        return;
      }

      // P7-04: Search results count
      let searchInfo = '';
      if (state.searchQuery.trim()) {
        searchInfo = `<div class="search-results-count">${filtered.length} result${filtered.length !== 1 ? 's' : ''} for "${escapeHtml(state.searchQuery)}"</div>`;
      }

      const active = filtered.filter(t => t.status !== 'done');
      const done = filtered.filter(t => t.status === 'done')
        .sort((a, b) => new Date(b.completed_at || 0) - new Date(a.completed_at || 0));

      let html = searchInfo;

      if (active.length > 0) {
        html += `
          <div class="task-section">
            <div class="section-header">
              <div class="section-title">Active Tasks</div>
              <div class="section-count">${active.length}</div>
            </div>
            <div class="task-list">
              ${active.map(t => renderTaskRow(t)).join('')}
            </div>
          </div>
        `;
      }

      if (done.length > 0) {
        html += `
          <div class="task-section">
            <div class="section-header" id="doneToggle" style="cursor:pointer;user-select:none">
              <span>${state.doneExpanded ? '‚ñæ' : '‚ñ∏'}</span>
              <div class="section-title">Done</div>
              <div class="section-count">${done.length}</div>
            </div>
            <div class="task-list" style="${state.doneExpanded ? '' : 'display:none'}" id="doneList">
              ${done.slice(0, 20).map(t => renderTaskRow(t)).join('')}
            </div>
          </div>
        `;
      }

      const scrollTop = container.scrollTop;
      container.innerHTML = html;
      container.scrollTop = scrollTop;
    }

    // Render task row (P7-04: with search highlighting, P7-07: clickable status)
    function renderTaskRow(task) {
      const project = state.projects.find(p => p.id === task.project_id);
      const projectName = project ? project.name : task.project_id;
      const subtasksInfo = task.subtasks && task.subtasks.length > 0
        ? `${task.subtasks.filter(s => s.done).length}/${task.subtasks.length}`
        : '';
      const isDone = task.status === 'done';
      const isOverdue = !isDone && task.deadline && new Date(task.deadline) < new Date();
      const tagsHtml = (task.tags || []).map(t =>
        `<span class="meta-item" style="background:var(--bg-elevated);padding:1px 6px;border-radius:3px;font-family:monospace;font-size:11px">${escapeHtml(t)}</span>`
      ).join('');

      // P7-04: Highlight search matches
      const titleHtml = state.searchQuery.trim()
        ? highlightMatches(task.title, state.searchQuery)
        : escapeHtml(task.title);

      return `
        <div class="task-row ${task.status === 'blocked' ? 'blocked' : ''} ${isDone ? 'done-task' : ''}" data-task-id="${task.id}">
          <div class="priority-bar ${task.priority}"></div>
          <input type="checkbox" class="task-checkbox" data-task-id="${task.id}" ${isDone ? 'checked' : ''}>
          <div class="task-content">
            <div class="task-title" ${isDone ? 'style="text-decoration:line-through;color:var(--text-muted)"' : ''}>${titleHtml}</div>
            <div class="task-meta">
              <span class="meta-item">${escapeHtml(projectName)}</span>
              ${task.assigned_to ? `<span class="meta-item">@${escapeHtml(task.assigned_to)}</span>` : ''}
              ${tagsHtml}
              ${subtasksInfo ? `<span class="meta-item"><span class="subtask-progress"><span class="subtask-progress-fill" style="width:${Math.round(task.subtasks.filter(s=>s.done).length / task.subtasks.length * 100)}%"></span></span>${subtasksInfo}</span>` : ''}
              ${task.deadline ? `<span class="meta-item" ${isOverdue ? 'style="color:var(--priority-critical);font-weight:600"' : ''}>${isOverdue ? '‚ö† OVERDUE ¬∑ ' : ''}${formatDate(task.deadline)}</span>` : ''}
            </div>
          </div>
          <div class="task-status ${task.status} status-pill-clickable" data-task-id="${task.id}" style="position:relative">${task.status.replace('_', ' ')}</div>
        </div>
      `;
    }

    // Render footer stats
    function renderFooterStats() {
      const container = document.getElementById('footerStats');
      const total = state.tasks.length;
      const done = state.tasks.filter(t => t.status === 'done').length;
      const active = total - done;
      const overdue = state.tasks.filter(t =>
        t.status !== 'done' && t.deadline && new Date(t.deadline) < new Date()
      ).length;

      container.innerHTML = `
        <span>${total} total</span>
        <span>${active} active</span>
        <span>${done} done</span>
        ${overdue > 0 ? `<span style="color: var(--priority-critical)">${overdue} overdue</span>` : ''}
      `;
    }

    // Render detail panel
    function renderDetailPanel(task) {
      const container = document.getElementById('detailContent');
      const project = state.projects.find(p => p.id === task.project_id);

      // Get valid status transitions
      let statusOptions = '';
      if (task.status === 'done') {
        statusOptions = '<option value="reopen">Reopen</option>';
      } else {
        const transitions = {
          'backlog': ['in_progress', 'blocked', 'done'],
          'in_progress': ['blocked', 'in_review', 'done'],
          'blocked': ['backlog', 'in_progress'],
          'in_review': ['done', 'in_progress']
        };

        const validNext = transitions[task.status] || [];
        statusOptions = validNext.map(s =>
          `<option value="${s}">${s.replace('_', ' ')}</option>`
        ).join('');
      }

      container.innerHTML = `
        <div class="dp-section">
          <div class="dp-title" id="taskTitle" style="cursor:pointer" title="Click to edit">${escapeHtml(task.title)}</div>
          <input type="text" class="dp-input" id="titleEditInput" style="display:none;font-size:18px;font-weight:600" value="${escapeHtml(task.title)}" maxlength="200">
          <div class="dp-description" id="taskDescription" style="cursor:pointer;white-space:pre-wrap" title="Click to edit">${task.description ? escapeHtml(task.description) : '<span style="color:var(--text-muted)">No description ‚Äî click to add</span>'}</div>
          <textarea class="dp-input" id="descEditInput" style="display:none;min-height:80px;resize:vertical;font-family:inherit">${task.description ? escapeHtml(task.description) : ''}</textarea>
        </div>

        <div class="dp-section">
          <div class="dp-label">Project</div>
          <select class="dp-select" id="detailProject" data-field="project_id">
            ${state.projects.map(p => `
              <option value="${p.id}" ${p.id === task.project_id ? 'selected' : ''}>${escapeHtml(p.name)}</option>
            `).join('')}
          </select>
        </div>

        <div class="dp-section">
          <div class="dp-label">Status</div>
          <select class="dp-select" id="detailStatus" data-field="status">
            ${task.status === 'done' ? statusOptions : `
              <option value="${task.status}" selected>${task.status.replace('_', ' ')}</option>
              ${statusOptions}
            `}
          </select>
        </div>

        <div class="dp-section">
          <div class="dp-label">Priority</div>
          <select class="dp-select" id="detailPriority" data-field="priority">
            <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
            <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
            <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
            <option value="critical" ${task.priority === 'critical' ? 'selected' : ''}>Critical</option>
          </select>
        </div>

        <div class="dp-section">
          <div class="dp-label">Assigned To</div>
          <select class="dp-select" id="detailAssigned" data-field="assigned_to">
            <option value="athena" ${task.assigned_to === 'athena' ? 'selected' : ''}>Athena</option>
            <option value="wilson" ${task.assigned_to === 'wilson' ? 'selected' : ''}>Wilson</option>
            <option value="shared" ${task.assigned_to === 'shared' ? 'selected' : ''}>Shared</option>
          </select>
        </div>

        <div class="dp-section">
          <div class="dp-label">Deadline</div>
          <input type="date" class="dp-input" id="detailDeadline" data-field="deadline"
            value="${task.deadline ? task.deadline.split('T')[0] : ''}">
        </div>

        <div class="dp-section">
          <div class="dp-label">Subtasks</div>
          <div class="subtasks-list" id="subtasksList">
            ${(task.subtasks || []).map(st => `
              <div class="subtask-item">
                <input type="checkbox" ${st.done ? 'checked' : ''} data-subtask-id="${st.id}">
                <span class="subtask-text ${st.done ? 'done' : ''}">${escapeHtml(st.title)}</span>
                <button class="subtask-delete" data-subtask-id="${st.id}">√ó</button>
              </div>
            `).join('')}
          </div>
          <button class="subtask-add-btn" id="addSubtaskBtn">+ Add subtask</button>
        </div>

        <div class="dp-section">
          <div class="dp-label">Links</div>
          <div class="links-list" id="linksList">
            ${(() => {
              const LINK_META = {
                github_issue: { icon: 'üîÄ', label: 'GitHub Issue' },
                github_pr:    { icon: 'üîÉ', label: 'GitHub PR' },
                gdrive_doc:   { icon: 'üìÑ', label: 'Google Doc' },
                email_thread: { icon: '‚úâÔ∏è', label: 'Email Thread' },
              };
              function truncUrl(url) {
                if (!url) return '';
                try {
                  const u = new URL(url);
                  const p = u.pathname.length > 30 ? u.pathname.slice(0, 30) + '...' : u.pathname;
                  return u.hostname + p;
                } catch { return url.length > 50 ? url.slice(0, 50) + '...' : url; }
              }
              const links = task.links || {};
              return Object.entries(links).filter(([,v]) => v != null).map(([type, url]) => {
                const meta = LINK_META[type] || { icon: 'üîó', label: type };
                const isFilePath = url.startsWith('/');
                const displayUrl = truncUrl(url);
                return `
                  <div class="link-item" data-link-type="${type}">
                    <span class="link-icon">${meta.icon}</span>
                    <div class="link-content">
                      <div class="link-label">${escapeHtml(meta.label)}</div>
                      ${isFilePath
                        ? `<span class="link-url" style="cursor:default">${escapeHtml(displayUrl)}</span>`
                        : `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="link-url" title="${escapeHtml(url)}">${escapeHtml(displayUrl)}</a>`
                      }
                    </div>
                    <button class="link-copy" data-url="${escapeHtml(url)}" title="Copy link">üìã</button>
                    <button class="link-delete" data-link-type="${type}" title="Remove link">√ó</button>
                  </div>
                `;
              }).join('');
            })()}
          </div>
          <button class="link-add-btn" id="addLinkBtn">+ Add link</button>
        </div>

        <div class="dp-section">
          <div class="dp-label">Activity</div>
          <div class="activity-list">
            ${(task.activity || []).reverse().map(a => `
              <div class="activity-item">
                <strong>${escapeHtml(a.by)}</strong> ${escapeHtml(a.action)}${a.detail ? `: ${escapeHtml(a.detail)}` : ''}
                <div class="activity-time">${formatRelativeTime(a.at)}</div>
              </div>
            `).join('')}
          </div>
          <div class="comment-input">
            <input type="text" class="dp-input" id="commentInput" placeholder="Add a comment...">
            <button class="btn" id="addCommentBtn">Add</button>
          </div>
        </div>

        ${task.status === 'done' && task.report ? `
        <div class="dp-section">
          <div class="dp-label">Report</div>
          <div style="background:var(--bg-base);padding:12px;border-radius:8px;border:1px solid var(--border)">
            <div style="margin-bottom:8px;font-size:12px;font-weight:500">
              ${task.report.verified ? '‚úÖ Verified' : '‚ö†Ô∏è Not verified'}
              ${task.report.verified_at ? ` ¬∑ ${formatRelativeTime(task.report.verified_at)}` : ''}
            </div>
            ${task.report.summary ? `<div style="font-size:14px;margin-bottom:8px;line-height:1.5">${escapeHtml(task.report.summary)}</div>` : ''}
            ${task.report.files_changed?.length ? `<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px"><strong>Files:</strong> ${task.report.files_changed.map(f => '<code style="background:var(--bg-elevated);padding:2px 6px;border-radius:3px;font-family:monospace;font-size:11px">' + escapeHtml(f) + '</code>').join(', ')}</div>` : ''}
            ${task.report.time_spent_minutes ? `<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px"><strong>Time:</strong> ${task.report.time_spent_minutes} minutes</div>` : ''}
            ${task.report.verification_notes ? `<div style="font-size:12px;color:var(--text-secondary);line-height:1.5">${escapeHtml(task.report.verification_notes)}</div>` : ''}
          </div>
        </div>
        ` : ''}
      `;

      // Attach detail panel event listeners
      attachDetailPanelListeners(task);
    }

    // Attach detail panel listeners
    function attachDetailPanelListeners(task) {
      // Title inline editing (P3-10)
      const titleEl = document.getElementById('taskTitle');
      const titleInput = document.getElementById('titleEditInput');
      if (titleEl && titleInput) {
        titleEl.addEventListener('click', () => {
          titleEl.style.display = 'none';
          titleInput.style.display = 'block';
          titleInput.focus();
          titleInput.select();
        });

        let titleCancelled = false;
        const saveTitle = async () => {
          if (titleCancelled) { titleCancelled = false; titleInput.style.display = 'none'; titleEl.style.display = 'block'; return; }
          const newTitle = titleInput.value.trim();
          if (!newTitle || newTitle.length < 3) {
            showToast('Title must be 3-200 characters', 'error');
            titleInput.value = task.title;
            titleInput.style.display = 'none';
            titleEl.style.display = 'block';
            return;
          }
          if (newTitle === task.title) { titleInput.style.display = 'none'; titleEl.style.display = 'block'; return; }
          try {
            await api(`/tasks/${task.id}`, { method: 'PATCH', body: JSON.stringify({ title: newTitle }) });
            fetchData();
          } catch (err) {
            showToast(err.message, 'error');
            titleInput.value = task.title;
          }
          titleInput.style.display = 'none';
          titleEl.style.display = 'block';
        };

        titleInput.addEventListener('blur', saveTitle);
        titleInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); titleInput.blur(); }
          if (e.key === 'Escape') { titleCancelled = true; titleInput.value = task.title; titleInput.blur(); }
        });
      }

      // Description inline editing (P3-10)
      const descEl = document.getElementById('taskDescription');
      const descInput = document.getElementById('descEditInput');
      if (descEl && descInput) {
        descEl.addEventListener('click', () => {
          descEl.style.display = 'none';
          descInput.style.display = 'block';
          descInput.focus();
        });

        const saveDesc = async () => {
          const newDesc = descInput.value.trim();
          try {
            await api(`/tasks/${task.id}`, { method: 'PATCH', body: JSON.stringify({ description: newDesc || null }) });
            fetchData();
          } catch (err) {
            showToast(err.message, 'error');
            descInput.value = task.description || '';
          }
          descInput.style.display = 'none';
          descEl.style.display = 'block';
        };

        descInput.addEventListener('blur', saveDesc);
        descInput.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') { descInput.value = task.description || ''; descInput.blur(); }
        });
      }

      // Field change handlers (P7-02: with optimistic updates)
      document.querySelectorAll('#detailContent [data-field]').forEach(el => {
        el.addEventListener('change', async (e) => {
          const field = e.target.dataset.field;
          let value = e.target.value;

          // Handle status special case
          if (field === 'status' && value === 'reopen') {
            try {
              await api(`/tasks/${task.id}/reopen`, {
                method: 'POST',
                body: JSON.stringify({ reason: 'Reopened from UI', by: 'user' })
              });
              showToast('Task reopened', 'success');
              fetchData();
              return;
            } catch (error) {
              showToast(error.message, 'error');
              return;
            }
          }

          // Handle deadline empty string
          if (field === 'deadline' && value === '') {
            value = null;
          }

          // P7-02: Use optimistic update for status, priority, assigned_to
          if (['status', 'priority', 'assigned_to'].includes(field)) {
            // Handle status transitions to 'done'
            if (field === 'status' && value === 'done') {
              api(`/tasks/${task.id}/complete`, {
                method: 'POST',
                body: JSON.stringify({
                  summary: 'Completed from detail panel',
                  verified: true,
                  files_changed: [],
                  time_spent_minutes: 0
                })
              }).then(() => {
                showCelebration();
                fetchData();
              }).catch(err => showToast(err.message, 'error'));
              return;
            }

            optimisticUpdate(task.id, { [field]: value }, () =>
              api(`/tasks/${task.id}`, {
                method: 'PATCH',
                body: JSON.stringify({ [field]: value })
              })
            );
          } else {
            // Non-optimistic for other fields
            try {
              await api(`/tasks/${task.id}`, {
                method: 'PATCH',
                body: JSON.stringify({ [field]: value })
              });
              task[field] = value;
              showToast('Updated', 'success');
              fetchData();
            } catch (error) {
              showToast(error.message, 'error');
            }
          }
        });
      });

      // Subtask checkbox (P7-02: with optimistic update)
      document.querySelectorAll('#subtasksList input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', async (e) => {
          const stId = e.target.dataset.subtaskId;
          const subtask = task.subtasks.find(s => s.id === stId);
          if (!subtask) return;

          const newDone = e.target.checked;
          optimisticUpdate(task.id, {
            subtasks: task.subtasks.map(s => s.id === stId ? { ...s, done: newDone } : s)
          }, () =>
            api(`/tasks/${task.id}/subtasks/${stId}`, {
              method: 'PATCH',
              body: JSON.stringify({ done: newDone })
            })
          );
        });
      });

      // Subtask delete
      document.querySelectorAll('.subtask-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const stId = e.target.dataset.subtaskId;
          try {
            await api(`/tasks/${task.id}/subtasks/${stId}`, { method: 'DELETE' });
            fetchData();
          } catch (error) {
            showToast(error.message, 'error');
          }
        });
      });

      // Add subtask
      document.getElementById('addSubtaskBtn').addEventListener('click', (e) => {
        const btn = e.target;
        const parent = btn.parentElement;

        // Create input row
        const inputRow = document.createElement('div');
        inputRow.className = 'subtask-input-row';
        inputRow.innerHTML = `
          <input type="text" class="dp-input subtask-input" placeholder="Subtask title" id="newSubtaskInput">
          <button class="btn btn-secondary" id="cancelSubtask">Cancel</button>
        `;

        btn.style.display = 'none';
        parent.appendChild(inputRow);

        const input = document.getElementById('newSubtaskInput');
        input.focus();

        const submit = async () => {
          const title = input.value.trim();
          if (!title) return;

          try {
            await api(`/tasks/${task.id}/subtasks`, {
              method: 'POST',
              body: JSON.stringify({ title })
            });
            fetchData();
          } catch (error) {
            showToast(error.message, 'error');
          }
        };

        const cancel = () => {
          inputRow.remove();
          btn.style.display = 'block';
        };

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') submit();
          if (e.key === 'Escape') cancel();
        });

        document.getElementById('cancelSubtask').addEventListener('click', cancel);
      });

      // P10-05: Link management (object format)
      document.querySelectorAll('.link-copy').forEach(btn => {
        btn.addEventListener('click', () => {
          navigator.clipboard.writeText(btn.dataset.url).then(() => showToast('Link copied'));
        });
      });

      document.querySelectorAll('.link-delete').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            await api(`/tasks/${task.id}`, {
              method: 'PATCH',
              body: JSON.stringify({ links: { [btn.dataset.linkType]: null } })
            });
            fetchData();
          } catch (error) { showToast(error.message, 'error'); }
        });
      });

      const addLinkBtn = document.getElementById('addLinkBtn');
      if (addLinkBtn) {
        addLinkBtn.addEventListener('click', () => {
          addLinkBtn.style.display = 'none';
          const linksList = document.getElementById('linksList');
          const form = document.createElement('div');
          form.className = 'link-form';
          // Only show types that aren't already set
          const existing = task.links || {};
          const types = [
            { val: 'github_issue', label: 'GitHub Issue' },
            { val: 'github_pr', label: 'GitHub PR' },
            { val: 'gdrive_doc', label: 'Google Doc' },
            { val: 'email_thread', label: 'Email Thread' },
          ].filter(t => !existing[t.val]);
          form.innerHTML = `
            <select class="dp-select" id="linkTypeSelect">
              ${types.map(t => `<option value="${t.val}">${t.label}</option>`).join('')}
            </select>
            <input type="text" class="dp-input" id="linkUrlInput" placeholder="https://... or /path/to/file">
            <div class="link-form-row">
              <button class="btn btn-secondary" id="cancelLinkBtn">Cancel</button>
              <button class="btn" id="saveLinkBtn">Add</button>
            </div>
          `;
          linksList.appendChild(form);

          // Auto-detect type from pasted URL
          const urlInput = document.getElementById('linkUrlInput');
          urlInput.addEventListener('paste', (e) => {
            setTimeout(() => {
              const url = urlInput.value.trim();
              const sel = document.getElementById('linkTypeSelect');
              if (url.includes('github.com') && url.includes('/pull/')) sel.value = 'github_pr';
              else if (url.includes('github.com')) sel.value = 'github_issue';
              else if (url.match(/drive\.google\.com|docs\.google\.com/)) sel.value = 'gdrive_doc';
            }, 50);
          });

          const cancel = () => { form.remove(); addLinkBtn.style.display = 'block'; };
          const save = async () => {
            const type = document.getElementById('linkTypeSelect').value;
            const url = urlInput.value.trim();
            if (!url) { showToast('URL is required', 'error'); return; }
            try {
              await api(`/tasks/${task.id}`, {
                method: 'PATCH',
                body: JSON.stringify({ links: { [type]: url } })
              });
              fetchData();
            } catch (error) { showToast(error.message, 'error'); }
          };

          document.getElementById('cancelLinkBtn').addEventListener('click', cancel);
          document.getElementById('saveLinkBtn').addEventListener('click', save);
          urlInput.focus();
        });
      }

      // Add comment
      const addComment = async () => {
        const input = document.getElementById('commentInput');
        const text = input.value.trim();
        if (!text) return;

        try {
          await api(`/tasks/${task.id}/activity`, {
            method: 'POST',
            body: JSON.stringify({ by: 'user', action: 'commented', detail: text })
          });
          input.value = '';
          fetchData();
        } catch (error) {
          showToast(error.message, 'error');
        }
      };

      document.getElementById('addCommentBtn').addEventListener('click', addComment);
      document.getElementById('commentInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addComment();
      });
    }

    // Open detail panel (P7-09: mobile body scroll lock)
    function openDetailPanel(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      state.selectedTask = task;
      renderDetailPanel(task);
      document.getElementById('detailPanel').classList.add('open');

      // P7-09: Prevent body scroll on mobile
      if (window.innerWidth <= 640) {
        document.body.classList.add('panel-open');
      }
    }

    // Close detail panel (P7-09: mobile body scroll unlock)
    function closeDetailPanel() {
      document.getElementById('detailPanel').classList.remove('open');
      state.selectedTask = null;

      // P7-09: Re-enable body scroll on mobile
      if (window.innerWidth <= 640) {
        document.body.classList.remove('panel-open');
      }
    }

    // Quick complete task
    async function quickCompleteTask(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      try {
        // If backlog, first move to in_progress
        if (task.status === 'backlog') {
          await api(`/tasks/${taskId}`, {
            method: 'PATCH',
            body: JSON.stringify({ status: 'in_progress' })
          });
        }

        // Complete the task
        await api(`/tasks/${taskId}/complete`, {
          method: 'POST',
          body: JSON.stringify({
            summary: 'Completed via quick-complete',
            verified: true,
            files_changed: [],
            time_spent_minutes: 0
          })
        });

        showCelebration();
        fetchData();
      } catch (error) {
        showToast(error.message, 'error');
        // Revert checkbox
        const cb = document.querySelector(`.task-checkbox[data-task-id="${taskId}"]`);
        if (cb) cb.checked = false;
        fetchData();
      }
    }

    // New task modal
    function showNewTaskModal() {
      // Populate project dropdown
      const projectSelect = document.getElementById('newTaskProject');
      projectSelect.innerHTML = state.projects.map(p =>
        `<option value="${p.id}">${escapeHtml(p.name)}</option>`
      ).join('');

      // Set default project to selected tab or proj_personal
      const defaultProject = state.selectedProject !== 'ALL'
        ? state.selectedProject
        : (state.projects.find(p => p.id === 'proj_personal')?.id || state.projects[0]?.id);

      if (defaultProject) {
        projectSelect.value = defaultProject;
      }

      document.getElementById('newTaskModal').classList.add('show');
      setTimeout(() => document.getElementById('newTaskTitle').focus(), 50);
    }

    function hideNewTaskModal() {
      document.getElementById('newTaskModal').classList.remove('show');
      document.getElementById('newTaskTitle').value = '';
      document.getElementById('newTaskDescription').value = '';
      document.getElementById('newTaskDeadline').value = '';
      const tagsInput = document.getElementById('newTaskTags');
      if (tagsInput) tagsInput.value = '';
    }

    // Disconnect handler
    document.getElementById('disconnectBtn').addEventListener('click', () => {
      localStorage.removeItem('athena_tasks_token');
      state.tasks = [];
      state.projects = [];
      if (state.pollInterval) clearInterval(state.pollInterval);
      render();
      showAuthModal();
    });

    document.getElementById('statsBtn').addEventListener('click', () => {
      state.statsView = !state.statsView;
      if (state.statsView) { state.historyView = false; state.dashboardView = false; }
      renderTaskList();
    });

    document.getElementById('newTaskBtn').addEventListener('click', showNewTaskModal);
    document.getElementById('cancelNewTask').addEventListener('click', hideNewTaskModal);

    // P7-03: Global keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Guard: ignore when typing in input/textarea/select/contenteditable
      const isTyping = ['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName) ||
                       e.target.isContentEditable;

      // Escape key (highest priority)
      if (e.key === 'Escape') {
        const contextMenu = document.getElementById('contextMenu');
        if (contextMenu.classList.contains('show')) {
          contextMenu.classList.remove('show');
          return;
        }
        if (state.searchQuery.trim()) {
          clearSearch();
          return;
        }
        if (document.getElementById('newTaskModal').classList.contains('show')) {
          hideNewTaskModal();
          return;
        }
        if (document.getElementById('detailPanel').classList.contains('open')) {
          closeDetailPanel();
          return;
        }
        return;
      }

      // Skip other shortcuts when typing
      if (isTyping) return;

      // 'n' ‚Üí open new task modal
      if (e.key === 'n' || e.key === 'N') {
        showNewTaskModal();
        return;
      }

      // '/' ‚Üí focus search
      if (e.key === '/') {
        e.preventDefault();
        openSearch();
        return;
      }

      // Arrow navigation
      const filteredTasks = getFilteredTasks().filter(t => t.status !== 'done');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (state.selectedTaskIndex < filteredTasks.length - 1) {
          state.selectedTaskIndex++;
          highlightSelectedTask();
        }
        return;
      }

      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (state.selectedTaskIndex > 0) {
          state.selectedTaskIndex--;
          highlightSelectedTask();
        } else if (state.selectedTaskIndex === -1 && filteredTasks.length > 0) {
          state.selectedTaskIndex = 0;
          highlightSelectedTask();
        }
        return;
      }

      // Enter ‚Üí open selected task
      if (e.key === 'Enter' && state.selectedTaskIndex >= 0) {
        const task = filteredTasks[state.selectedTaskIndex];
        if (task) {
          openDetailPanel(task.id);
          state.selectedTaskIndex = -1;
        }
        return;
      }

      // Priority shortcuts when detail panel is open
      const detailPanelOpen = document.getElementById('detailPanel').classList.contains('open');
      if (detailPanelOpen && state.selectedTask) {
        if (['1', '2', '3', '4'].includes(e.key)) {
          const priorities = { '1': 'critical', '2': 'high', '3': 'medium', '4': 'low' };
          const priority = priorities[e.key];
          optimisticUpdate(state.selectedTask.id, { priority }, () =>
            api(`/tasks/${state.selectedTask.id}`, {
              method: 'PATCH',
              body: JSON.stringify({ priority })
            })
          );
          return;
        }

        // 's' ‚Üí cycle status
        if (e.key === 's' || e.key === 'S') {
          cycleTaskStatus(state.selectedTask);
          return;
        }
      }
    });

    // P7-03: Highlight selected task
    function highlightSelectedTask() {
      document.querySelectorAll('.task-row').forEach(row => row.classList.remove('selected'));
      const filteredTasks = getFilteredTasks().filter(t => t.status !== 'done');
      if (state.selectedTaskIndex >= 0 && state.selectedTaskIndex < filteredTasks.length) {
        const task = filteredTasks[state.selectedTaskIndex];
        const row = document.querySelector(`.task-row[data-task-id="${task.id}"]`);
        if (row) {
          row.classList.add('selected');
          row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      }
    }

    // P7-03: Cycle task status
    function cycleTaskStatus(task) {
      const transitions = {
        'backlog': 'in_progress',
        'in_progress': 'in_review',
        'blocked': 'in_progress',
        'in_review': 'done',
        'done': 'backlog'
      };
      const nextStatus = transitions[task.status] || 'backlog';

      if (nextStatus === 'done') {
        // Use complete API
        api(`/tasks/${task.id}/complete`, {
          method: 'POST',
          body: JSON.stringify({
            summary: 'Completed via keyboard shortcut',
            verified: true,
            files_changed: [],
            time_spent_minutes: 0
          })
        }).then(() => {
          showCelebration();
          fetchData();
        }).catch(err => showToast(err.message, 'error'));
      } else {
        optimisticUpdate(task.id, { status: nextStatus }, () =>
          api(`/tasks/${task.id}`, {
            method: 'PATCH',
            body: JSON.stringify({ status: nextStatus })
          })
        );
      }
    }

    // P7-04: Search helpers
    function openSearch() {
      const wrapper = document.getElementById('searchWrapper');
      const input = document.getElementById('searchInput');
      wrapper.classList.add('open');
      input.focus();
    }

    function clearSearch() {
      state.searchQuery = '';
      document.getElementById('searchInput').value = '';
      document.getElementById('searchWrapper').classList.remove('open');
      render();
    }

    // P7-04: Search event handlers
    let searchDebounce;
    document.getElementById('searchInput').addEventListener('input', (e) => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => {
        state.searchQuery = e.target.value;
        state.selectedTaskIndex = -1;
        render();
      }, 150);
    });

    document.getElementById('searchBtn').addEventListener('click', openSearch);
    document.getElementById('searchClear').addEventListener('click', clearSearch);

    // P7-09: Mobile filter bottom sheet
    function openFilterSheet() {
      const sheet = document.getElementById('filterSheet');
      const overlay = document.getElementById('filterSheetOverlay');
      const content = document.getElementById('filterSheetContent');

      // Build filter chips from current state
      const sections = [
        { key: 'status', label: 'Status', options: ['backlog', 'in_progress', 'blocked', 'in_review', 'done'] },
        { key: 'priority', label: 'Priority', options: ['critical', 'high', 'medium', 'low'] },
        { key: 'assigned_to', label: 'Assigned', options: ['wilson', 'athena', 'shared'] }
      ];

      content.innerHTML = sections.map(section => `
        <div class="filter-sheet-section">
          <div class="filter-sheet-section-title">${section.label}</div>
          <div class="filter-sheet-options">
            ${section.options.map(opt => `
              <div class="filter-sheet-chip ${state.filters[section.key].includes(opt) ? 'active' : ''}"
                   data-filter-key="${section.key}" data-filter-value="${opt}">
                ${opt.replace('_', ' ')}
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');

      // Chip toggle handlers
      content.querySelectorAll('.filter-sheet-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const key = chip.dataset.filterKey;
          const value = chip.dataset.filterValue;
          chip.classList.toggle('active');
          if (chip.classList.contains('active')) {
            if (!state.filters[key].includes(value)) state.filters[key].push(value);
          } else {
            state.filters[key] = state.filters[key].filter(v => v !== value);
          }
        });
      });

      sheet.classList.add('open');
      overlay.classList.add('show');
    }

    function closeFilterSheet() {
      document.getElementById('filterSheet').classList.remove('open');
      document.getElementById('filterSheetOverlay').classList.remove('show');
      render();
    }

    document.getElementById('mobileFilterToggle').addEventListener('click', openFilterSheet);
    document.getElementById('closeFilterSheet').addEventListener('click', closeFilterSheet);
    document.getElementById('filterSheetOverlay').addEventListener('click', closeFilterSheet);
    document.getElementById('filterSheetApply').addEventListener('click', closeFilterSheet);
    document.getElementById('filterSheetClear').addEventListener('click', () => {
      state.filters = { status: [], priority: [], assigned_to: [], tags: [] };
      document.querySelectorAll('.filter-menu input[type="checkbox"]').forEach(cb => cb.checked = false);
      closeFilterSheet();
    });

    // Update mobile filter count badge
    function updateMobileFilterCount() {
      const count = Object.values(state.filters).reduce((sum, arr) => sum + arr.length, 0);
      const badge = document.getElementById('mobileFilterCount');
      if (badge) badge.textContent = count > 0 ? `(${count})` : '';
    }

    // P7-11: Right-click context menu
    document.addEventListener('contextmenu', (e) => {
      const taskRow = e.target.closest('.task-row');
      if (!taskRow) return;

      e.preventDefault();
      const taskId = taskRow.dataset.taskId;
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      const contextMenu = document.getElementById('contextMenu');

      // Status transitions
      const transitions = {
        'backlog': ['in_progress', 'blocked', 'done'],
        'in_progress': ['blocked', 'in_review', 'done'],
        'blocked': ['backlog', 'in_progress'],
        'in_review': ['done', 'in_progress']
      };
      const validStatuses = transitions[task.status] || [];

      contextMenu.innerHTML = `
        <div class="context-menu-item" data-action="priority" data-task-id="${taskId}">
          Set Priority
          <span>‚ñ∂</span>
          <div class="context-menu-submenu">
            <div class="context-menu-item" data-action="set-priority" data-task-id="${taskId}" data-value="critical" style="color:var(--priority-critical)">Critical</div>
            <div class="context-menu-item" data-action="set-priority" data-task-id="${taskId}" data-value="high" style="color:var(--priority-high)">High</div>
            <div class="context-menu-item" data-action="set-priority" data-task-id="${taskId}" data-value="medium" style="color:var(--priority-medium)">Medium</div>
            <div class="context-menu-item" data-action="set-priority" data-task-id="${taskId}" data-value="low" style="color:var(--priority-low)">Low</div>
          </div>
        </div>
        ${validStatuses.length > 0 ? `
        <div class="context-menu-item" data-action="status" data-task-id="${taskId}">
          Set Status
          <span>‚ñ∂</span>
          <div class="context-menu-submenu">
            ${validStatuses.map(s => `
              <div class="context-menu-item" data-action="set-status" data-task-id="${taskId}" data-value="${s}" style="color:var(--status-${s})">${s.replace('_', ' ')}</div>
            `).join('')}
          </div>
        </div>
        ` : ''}
        <div class="context-menu-item" data-action="assign" data-task-id="${taskId}">
          Assign To
          <span>‚ñ∂</span>
          <div class="context-menu-submenu">
            <div class="context-menu-item" data-action="set-assign" data-task-id="${taskId}" data-value="wilson">Wilson</div>
            <div class="context-menu-item" data-action="set-assign" data-task-id="${taskId}" data-value="athena">Athena</div>
            <div class="context-menu-item" data-action="set-assign" data-task-id="${taskId}" data-value="shared">Shared</div>
          </div>
        </div>
        ${task.status !== 'done' ? `<div class="context-menu-item" data-action="archive" data-task-id="${taskId}">Archive</div>` : ''}
      `;

      contextMenu.style.left = `${e.pageX}px`;
      contextMenu.style.top = `${e.pageY}px`;
      contextMenu.classList.add('show');

      // Adjust if off-screen
      requestAnimationFrame(() => {
        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
          contextMenu.style.left = `${window.innerWidth - rect.width - 10}px`;
        }
        if (rect.bottom > window.innerHeight) {
          contextMenu.style.top = `${window.innerHeight - rect.height - 10}px`;
        }
      });
    });

    // P7-11: Handle context menu actions
    function handleContextMenuAction(taskId, action, value) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      switch (action) {
        case 'set-priority':
          optimisticUpdate(taskId, { priority: value }, () =>
            api(`/tasks/${taskId}`, {
              method: 'PATCH',
              body: JSON.stringify({ priority: value })
            })
          );
          break;

        case 'set-status':
          if (value === 'done') {
            api(`/tasks/${taskId}/complete`, {
              method: 'POST',
              body: JSON.stringify({
                summary: 'Completed via context menu',
                verified: true,
                files_changed: [],
                time_spent_minutes: 0
              })
            }).then(() => {
              showCelebration();
              fetchData();
            }).catch(err => showToast(err.message, 'error'));
          } else {
            optimisticUpdate(taskId, { status: value }, () =>
              api(`/tasks/${taskId}`, {
                method: 'PATCH',
                body: JSON.stringify({ status: value })
              })
            );
          }
          break;

        case 'set-assign':
          optimisticUpdate(taskId, { assigned_to: value }, () =>
            api(`/tasks/${taskId}`, {
              method: 'PATCH',
              body: JSON.stringify({ assigned_to: value })
            })
          );
          break;

        case 'archive':
          if (confirm('Archive this task? This will mark it as done.')) {
            api(`/tasks/${taskId}/complete`, {
              method: 'POST',
              body: JSON.stringify({
                summary: 'Archived via context menu',
                verified: true,
                files_changed: [],
                time_spent_minutes: 0
              })
            }).then(() => {
              showToast('Task archived', 'success');
              fetchData();
            }).catch(err => showToast(err.message, 'error'));
          }
          break;
      }
    }

    // New task modal Enter key (submit unless in textarea)
    document.getElementById('newTaskModal').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
        document.getElementById('createTaskBtn').click();
      }
    });

    document.getElementById('createTaskBtn').addEventListener('click', async () => {
      const title = document.getElementById('newTaskTitle').value.trim();
      const description = document.getElementById('newTaskDescription').value.trim();
      const project_id = document.getElementById('newTaskProject').value;
      const priority = document.getElementById('newTaskPriority').value;
      const assigned_to = document.getElementById('newTaskAssigned').value;
      const deadline = document.getElementById('newTaskDeadline').value || null;
      const tagsRaw = document.getElementById('newTaskTags')?.value.trim() || '';
      const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim().toLowerCase()).filter(Boolean) : [];

      if (!title || title.length < 3) {
        showToast('Title is required (3-200 chars)', 'error');
        return;
      }

      try {
        await api('/tasks', {
          method: 'POST',
          body: JSON.stringify({
            title,
            description: description || null,
            project_id,
            priority,
            assigned_to,
            deadline,
            tags
          })
        });

        hideNewTaskModal();
        showToast('Task created', 'success');
        fetchData();
      } catch (error) {
        showToast(error.message, 'error');
      }
    });

    // Event delegation
    document.addEventListener('click', (e) => {
      // Project tab click
      if (e.target.closest('.tab')) {
        const tab = e.target.closest('.tab');

        // P8-06: Handle History tab
        if (tab.dataset.project === 'HISTORY') {
          state.historyView = true;
          state.dashboardView = false;
          state.selectedTaskIndex = -1;
          fetchHistory();
          return;
        }

        // Regular project tab
        state.historyView = false;
        state.statsView = false;
        state.selectedProject = tab.dataset.project;
        state.selectedTaskIndex = -1;
        render();
        return;
      }

      // P7-10: Dashboard toggle
      if (e.target.id === 'dashboardToggle') {
        state.dashboardView = e.target.checked;
        render();
        return;
      }

      // P10-12: Toggle archived projects
      if (e.target.id === 'toggleArchivedBtn') {
        state.showArchived = !state.showArchived;
        render();
        return;
      }

      // P10-12: Project status badge click ‚Äî show dropdown
      if (e.target.classList.contains('project-status-badge')) {
        e.stopPropagation();
        const badge = e.target;
        const projectId = badge.dataset.projectId;
        const currentStatus = badge.dataset.projectStatus;

        // Remove any existing project status menu
        document.querySelectorAll('.project-status-menu').forEach(m => m.remove());

        const validTransitions = {
          active: ['paused', 'completed'],
          paused: ['active', 'archived'],
          completed: ['archived', 'active'],
          archived: ['active']
        };
        const options = validTransitions[currentStatus] || [];

        const menu = document.createElement('div');
        menu.className = 'project-status-menu';
        menu.innerHTML = options.map(s => `
          <div class="project-status-option" data-project-id="${projectId}" data-new-status="${s}">${s}</div>
        `).join('');
        badge.style.position = 'relative';
        badge.appendChild(menu);
        return;
      }

      // P10-12: Project status option click
      if (e.target.classList.contains('project-status-option')) {
        e.stopPropagation();
        const projectId = e.target.dataset.projectId;
        const newStatus = e.target.dataset.newStatus;
        document.querySelectorAll('.project-status-menu').forEach(m => m.remove());

        api(`/projects/${projectId}`, {
          method: 'PATCH',
          body: JSON.stringify({ status: newStatus })
        }).then(() => {
          showToast(`Project ${newStatus}`, 'success');
          if (newStatus === 'completed') showProjectConfetti();
          fetchData();
        }).catch(err => showToast(err.message, 'error'));
        return;
      }

      // Remove project status menu when clicking elsewhere
      if (!e.target.closest('.project-status-badge')) {
        document.querySelectorAll('.project-status-menu').forEach(m => m.remove());
      }

      // P7-10: Dashboard project card click
      if (e.target.closest('.project-card')) {
        const card = e.target.closest('.project-card');
        const projectId = card.dataset.project;
        state.selectedProject = projectId;
        state.dashboardView = false;
        render();
        return;
      }

      // Done toggle
      if (e.target.closest('#doneToggle')) {
        state.doneExpanded = !state.doneExpanded;
        render();
        return;
      }

      // P7-07: Status pill click (show dropdown)
      if (e.target.classList.contains('status-pill-clickable')) {
        e.stopPropagation();
        const taskId = e.target.dataset.taskId;
        const task = state.tasks.find(t => t.id === taskId);
        if (!task) return;

        // Remove existing dropdown
        const existing = document.querySelector('.status-dropdown');
        if (existing) existing.remove();

        // Get valid transitions
        const transitions = {
          'backlog': ['in_progress', 'blocked', 'done'],
          'in_progress': ['blocked', 'in_review', 'done'],
          'blocked': ['backlog', 'in_progress'],
          'in_review': ['done', 'in_progress']
        };
        const validNext = transitions[task.status] || [];

        // Create dropdown
        const dropdown = document.createElement('div');
        dropdown.className = 'status-dropdown';
        dropdown.innerHTML = validNext.map(s => `
          <div class="status-option ${s}" data-task-id="${taskId}" data-status="${s}">
            ${s.replace('_', ' ')}
          </div>
        `).join('');

        e.target.appendChild(dropdown);
        return;
      }

      // P7-07: Status option click
      if (e.target.classList.contains('status-option')) {
        e.stopPropagation();
        const taskId = e.target.dataset.taskId;
        const newStatus = e.target.dataset.status;

        if (newStatus === 'done') {
          // Use complete API
          api(`/tasks/${taskId}/complete`, {
            method: 'POST',
            body: JSON.stringify({
              summary: 'Completed via quick status change',
              verified: true,
              files_changed: [],
              time_spent_minutes: 0
            })
          }).then(() => {
            showCelebration();
            fetchData();
          }).catch(err => showToast(err.message, 'error'));
        } else {
          optimisticUpdate(taskId, { status: newStatus }, () =>
            api(`/tasks/${taskId}`, {
              method: 'PATCH',
              body: JSON.stringify({ status: newStatus })
            })
          );
        }

        // Remove dropdown
        const dropdown = e.target.closest('.status-dropdown');
        if (dropdown) dropdown.remove();
        return;
      }

      // Remove status dropdown when clicking elsewhere
      if (!e.target.closest('.status-dropdown')) {
        const dropdown = document.querySelector('.status-dropdown');
        if (dropdown) dropdown.remove();
      }

      // Task row click (but not checkbox or status pill)
      if (e.target.closest('.task-row') &&
          !e.target.classList.contains('task-checkbox') &&
          !e.target.classList.contains('status-pill-clickable')) {
        const row = e.target.closest('.task-row');
        const taskId = row.dataset.taskId;
        state.selectedTaskIndex = -1;
        openDetailPanel(taskId);
        return;
      }

      // Task checkbox click
      if (e.target.classList.contains('task-checkbox')) {
        e.stopPropagation();
        const taskId = e.target.dataset.taskId;
        const task = state.tasks.find(t => t.id === taskId);

        if (task && task.status === 'done') {
          // Uncheck and don't allow
          e.target.checked = true;
          showToast('Use detail panel to reopen tasks', 'error');
        } else {
          quickCompleteTask(taskId);
        }
        return;
      }

      // Filter button click
      if (e.target.closest('.filter-btn')) {
        const btn = e.target.closest('.filter-btn');
        const filterType = btn.dataset.filter;
        const menu = document.querySelector(`[data-menu="${filterType}"]`);

        // Close all other menus
        document.querySelectorAll('.filter-menu').forEach(m => {
          if (m !== menu) m.classList.remove('show');
        });

        menu.classList.toggle('show');
        return;
      }

      // Filter option click
      if (e.target.closest('.filter-option input')) {
        const checkbox = e.target.closest('.filter-option input');
        const menu = checkbox.closest('.filter-menu');
        const filterType = menu.dataset.menu;
        const value = checkbox.value;

        if (checkbox.checked) {
          if (!state.filters[filterType].includes(value)) {
            state.filters[filterType].push(value);
          }
        } else {
          state.filters[filterType] = state.filters[filterType].filter(v => v !== value);
        }

        state.selectedTaskIndex = -1;
        render();
        return;
      }

      // Filter pill remove
      if (e.target.classList.contains('pill-remove')) {
        const type = e.target.dataset.type;
        const value = e.target.dataset.value;
        state.filters[type] = state.filters[type].filter(v => v !== value);

        // Uncheck the corresponding checkbox
        const menu = document.querySelector(`[data-menu="${type}"]`);
        if (menu) {
          const checkbox = menu.querySelector(`input[value="${value}"]`);
          if (checkbox) checkbox.checked = false;
        }

        state.selectedTaskIndex = -1;
        render();
        return;
      }

      // Clear filters
      if (e.target.id === 'clearFilters') {
        state.filters = {
          status: [],
          priority: [],
          assigned_to: [],
          tags: []
        };

        // Uncheck all checkboxes
        document.querySelectorAll('.filter-menu input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
        });

        state.selectedTaskIndex = -1;
        render();
        return;
      }

      // Close detail panel
      if (e.target.id === 'closeDetail') {
        closeDetailPanel();
        return;
      }

      // P7-11: Context menu item click
      if (e.target.closest('.context-menu-item[data-action]')) {
        const item = e.target.closest('.context-menu-item[data-action]');
        const action = item.dataset.action;
        const taskId = item.dataset.taskId;
        const value = item.dataset.value;

        handleContextMenuAction(taskId, action, value);
        document.getElementById('contextMenu').classList.remove('show');
        return;
      }

      // Close context menu when clicking outside
      const contextMenu = document.getElementById('contextMenu');
      if (!e.target.closest('.context-menu') && contextMenu.classList.contains('show')) {
        contextMenu.classList.remove('show');
      }

      // Close filter menus when clicking outside
      if (!e.target.closest('.filter-dropdown')) {
        document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('show'));
      }
    });

    // P10-14: Render stats/analytics view
    async function renderStatsView() {
      const container = document.getElementById('mainContent');

      // Fetch stats if not cached or period changed
      if (!state.statsData || state.statsData._period !== state.statsPeriod) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div class="empty-state-text">Loading analytics...</div></div>';
        try {
          state.statsData = await api(`/stats?period=${state.statsPeriod}`);
          state.statsData._period = state.statsPeriod;
        } catch (e) {
          container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-text">Failed to load stats</div></div>`;
          return;
        }
      }

      const s = state.statsData;
      const t = s.tasks;
      const a = s.athena;

      // CSS bar helper
      function bar(val, max, color) {
        const pct = max > 0 ? Math.round((val / max) * 100) : 0;
        return `<div style="flex:1;background:var(--bg-base);border-radius:4px;height:8px;overflow:hidden"><div style="width:${pct}%;height:100%;background:${color};border-radius:4px;transition:width 0.3s"></div></div>`;
      }

      container.innerHTML = `
        <div style="padding:20px;max-width:900px;margin:0 auto">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h2 style="font-size:18px;font-weight:700">üìä Analytics</h2>
            <div style="display:flex;gap:4px">
              ${['week', 'month', 'all'].map(p => `<button class="btn ${state.statsPeriod === p ? '' : 'btn-secondary'}" style="padding:4px 12px;font-size:12px" data-stats-period="${p}">${p === 'all' ? 'All Time' : p === 'week' ? 'This Week' : 'This Month'}</button>`).join('')}
            </div>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">${s.date_range.from} ‚Äî ${s.date_range.to}</div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
            <!-- Task Velocity -->
            <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px">
              <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px">Task Velocity</div>
              <div style="font-size:32px;font-weight:700;color:var(--status-done)">${t.total_completed}</div>
              <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">${t.total_created} created ¬∑ ${(t.completion_rate * 100).toFixed(0)}% completion rate</div>
              <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Avg: ${t.avg_completion_hours}h ¬∑ Median: ${t.median_completion_hours}h</div>
            </div>

            <!-- Athena Throughput -->
            <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px">
              <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px">Athena Throughput</div>
              <div style="font-size:32px;font-weight:700;color:var(--accent)">${a.tasks_per_day}</div>
              <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">tasks/day ¬∑ ${a.tasks_completed} completed ¬∑ avg ${a.avg_completion_minutes}min</div>
              <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
                <span style="font-size:11px;color:var(--text-muted)">Verified</span>
                ${bar(a.verification_pass_rate * 100, 100, 'var(--status-done)')}
                <span style="font-size:11px;color:var(--text-muted)">${(a.verification_pass_rate * 100).toFixed(0)}%</span>
              </div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
            <!-- Priority Breakdown -->
            <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px">
              <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">Priority Breakdown</div>
              ${Object.entries(t.by_priority).map(([p, count]) => {
                const colors = { critical: 'var(--priority-critical)', high: 'var(--priority-high)', medium: 'var(--priority-medium)', low: 'var(--priority-low)' };
                const max = Math.max(...Object.values(t.by_priority));
                return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                  <span style="font-size:11px;width:50px;color:var(--text-muted)">${p}</span>
                  ${bar(count, max, colors[p])}
                  <span style="font-size:11px;width:24px;text-align:right;color:var(--text-secondary)">${count}</span>
                </div>`;
              }).join('')}
            </div>

            <!-- Status Distribution -->
            <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px">
              <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">Status Distribution</div>
              ${Object.entries(t.by_status).map(([st, count]) => {
                const colors = { backlog: 'var(--status-backlog)', in_progress: 'var(--status-in-progress)', blocked: 'var(--status-blocked)', in_review: 'var(--status-in-review)', done: 'var(--status-done)' };
                const max = Math.max(...Object.values(t.by_status));
                return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                  <span style="font-size:11px;width:70px;color:var(--text-muted)">${st.replace('_', ' ')}</span>
                  ${bar(count, max, colors[st])}
                  <span style="font-size:11px;width:24px;text-align:right;color:var(--text-secondary)">${count}</span>
                </div>`;
              }).join('')}
            </div>
          </div>

          <!-- Project Health -->
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">Project Health</div>
            ${s.projects.map(p => `
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                <span style="font-size:13px;width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(p.name)}</span>
                ${bar(p.completion_pct, 100, 'var(--status-done)')}
                <span style="font-size:11px;width:36px;text-align:right;color:var(--text-secondary)">${p.completion_pct}%</span>
                <span style="font-size:11px;width:50px;text-align:right;color:var(--text-muted)">${p.active_tasks} active</span>
              </div>
            `).join('')}
          </div>

          <!-- System Health + Email -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px">
              <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">System Health</div>
              <div style="font-size:13px;line-height:2">
                <div>Uptime: <strong>${s.system.uptime_hours}h</strong></div>
                <div>Backups: <strong>${s.system.backup_count} files</strong></div>
                <div>Archives: <strong>${s.system.archive_months} months</strong></div>
                <div>Data loss: <strong style="color:${s.system.data_loss_incidents === 0 ? 'var(--status-done)' : 'var(--priority-critical)'}">${s.system.data_loss_incidents}</strong></div>
              </div>
            </div>
            <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px">
              <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Wilson & Email</div>
              <div style="font-size:13px;line-height:2">
                <div>Wilson created: <strong>${s.wilson.tasks_created}</strong></div>
                <div>Wilson completed: <strong>${s.wilson.tasks_completed}</strong></div>
                <div>Email tasks: <strong>${s.email.tasks_from_email}</strong></div>
                <div>Overdue: <strong style="color:${t.overdue_count > 0 ? 'var(--priority-critical)' : 'var(--status-done)'}">${t.overdue_count}</strong></div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Period selector events
      container.querySelectorAll('[data-stats-period]').forEach(btn => {
        btn.addEventListener('click', () => {
          state.statsPeriod = btn.dataset.statsPeriod;
          state.statsData = null;
          renderStatsView();
        });
      });

      // P10-14: Auto-refresh stats every 60 seconds
      clearInterval(state._statsRefreshInterval);
      state._statsRefreshInterval = setInterval(() => {
        if (state.statsView) {
          state.statsData = null;
          renderStatsView();
        } else {
          clearInterval(state._statsRefreshInterval);
        }
      }, 60000);
    }

    // P8-06: Render history view
    function renderHistoryView() {
      const container = document.getElementById('mainContent');
      const { tasks, pagination } = state.historyData;

      const filterBar = `
        <div class="history-filters">
          <select id="historyProjectFilter">
            <option value="">All Projects</option>
            ${state.projects.map(p => `
              <option value="${p.id}" ${state.historyFilters.project_id === p.id ? 'selected' : ''}>${escapeHtml(p.name)}</option>
            `).join('')}
          </select>
          <input type="month" id="historyMonthFilter" value="${state.historyFilters.month}" placeholder="Filter by month">
          <input type="text" id="historySearchFilter" value="${state.historyFilters.search}" placeholder="Search completed tasks...">
        </div>
      `;

      let tasksList = '';
      if (tasks.length === 0) {
        tasksList = `
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <div class="empty-state-text">No completed tasks found</div>
          </div>
        `;
      } else {
        tasksList = tasks.map(task => {
          const project = state.projects.find(p => p.id === task.project_id);
          const completedDate = task.completed_at
            ? new Date(task.completed_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
            : task.archived_at ? new Date(task.archived_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Unknown';

          const priorityBadge = `<span class="priority-badge priority-${task.priority}">${task.priority}</span>`;
          const reportPreview = task.report && task.report.summary ? task.report.summary.substring(0, 150) : 'No report available';

          return `
            <div class="history-task" data-task-id="${task.id}">
              <div class="history-task-header">
                <div class="history-task-title">${escapeHtml(task.title)}</div>
                <div class="history-task-meta">
                  ${priorityBadge}
                  <span>${project ? escapeHtml(project.name) : 'Unknown'}</span>
                  <span>${completedDate}</span>
                </div>
              </div>
              <div class="history-report-preview">${escapeHtml(reportPreview)}</div>
            </div>
          `;
        }).join('');
      }

      const paginationControls = pagination.total > 0 ? `
        <div class="history-pagination">
          <div class="history-pagination-info">
            Page ${pagination.page} of ${pagination.total_pages} (${pagination.total} tasks)
          </div>
          <div class="history-pagination-controls">
            <button id="historyPrevPage" ${pagination.page <= 1 ? 'disabled' : ''}>Previous</button>
            <button id="historyNextPage" ${pagination.page >= pagination.total_pages ? 'disabled' : ''}>Next</button>
          </div>
        </div>
      ` : '';

      container.innerHTML = filterBar + tasksList + paginationControls;

      // Attach event listeners
      const projectFilter = document.getElementById('historyProjectFilter');
      if (projectFilter) {
        projectFilter.addEventListener('change', (e) => {
          state.historyFilters.project_id = e.target.value;
          state.historyPage = 1;
          fetchHistory();
        });
      }

      const monthFilter = document.getElementById('historyMonthFilter');
      if (monthFilter) {
        monthFilter.addEventListener('change', (e) => {
          state.historyFilters.month = e.target.value;
          state.historyPage = 1;
          fetchHistory();
        });
      }

      const searchFilter = document.getElementById('historySearchFilter');
      if (searchFilter) {
        searchFilter.addEventListener('input', (e) => {
          state.historyFilters.search = e.target.value;
          state.historyPage = 1;
          fetchHistory();
        });
      }

      const prevBtn = document.getElementById('historyPrevPage');
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (state.historyPage > 1) {
            state.historyPage--;
            fetchHistory();
          }
        });
      }

      const nextBtn = document.getElementById('historyNextPage');
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (state.historyPage < pagination.total_pages) {
            state.historyPage++;
            fetchHistory();
          }
        });
      }

      // Attach click listeners to history tasks
      document.querySelectorAll('.history-task').forEach(taskEl => {
        taskEl.addEventListener('click', () => {
          const taskId = taskEl.dataset.taskId;
          const task = tasks.find(t => t.id === taskId);
          if (task) {
            state.selectedTask = task;
            renderDetailPanel(task);
          }
        });
      });
    }

    // Render
    function render() {
      renderProjectTabs();
      renderFilters();
      renderTaskList();
      renderFooterStats();

      // Re-render detail panel if open
      if (state.selectedTask) {
        const updatedTask = state.tasks.find(t => t.id === state.selectedTask.id);
        if (updatedTask) {
          state.selectedTask = updatedTask;
          renderDetailPanel(updatedTask);
        }
      }
    }

    // Polling
    function startPolling() {
      if (state.pollInterval) {
        clearInterval(state.pollInterval);
      }

      state.pollInterval = setInterval(() => {
        if (!document.hidden) {
          fetchData();
        }
      }, 5000);
    }

    // Init
    async function init() {
      const token = localStorage.getItem('athena_tasks_token');
      if (!token) {
        showAuthModal();
        return;
      }

      await fetchData();
      startPolling();
    }

    // Start
    init();
  </script>
</body>
</html>
